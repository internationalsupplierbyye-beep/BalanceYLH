<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Balance (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin:0; padding:0; background:#f5f7fb; color:#111827; }
    header { background:#1b4ba0; color:#fff; padding:16px 24px; }
    header h1 { margin:0; font-size:20px; }
    header p { margin:4px 0 0 0; font-size:13px; opacity:0.9; }
    main { padding:16px; max-width:1300px; margin:0 auto 40px auto; }

    .card { background:#fff; border-radius:10px; padding:16px; margin-bottom:16px; box-shadow:0 1px 4px rgba(15,23,42,0.08); }
    .card h2 { margin:0 0 8px 0; font-size:18px; }
    .card small { display:block; font-size:12px; color:#4b5563; margin-bottom:12px; }

    form { display:grid; grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); gap:8px 12px; align-items:flex-end; }
    label { display:flex; flex-direction:column; gap:4px; font-size:13px; }
    input[type="number"], input[type="date"], input[type="text"] {
      padding:6px 8px; border-radius:6px; border:1px solid #d1d5db; font-size:13px;
    }
    input[type="number"] { text-align:right; }
    input:focus { outline:2px solid #1b4ba0; outline-offset:1px; border-color:#1b4ba0; }
    select {
      padding:4px 6px; border-radius:6px; border:1px solid #d1d5db; font-size:13px;
      background:#fff;
    }

    .btn-row { display:flex; gap:8px; margin-top:4px; flex-wrap:wrap; align-items:center; }
    button { border:none; border-radius:6px; padding:6px 12px; font-size:13px; cursor:pointer; }
    .btn-primary { background:#1b4ba0; color:#fff; }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-small { padding:4px 8px; font-size:11px; }

    .table-container { max-height: 360px; overflow-y: auto; overflow-x: auto; }
    table { border-collapse:collapse; width:100%; min-width:1100px; font-size:12px; }
    thead { background:#1d4ed8; color:#fff; position:sticky; top:0; }
    th, td { border:1px solid #e5e7eb; padding:4px 6px; text-align:right; white-space:nowrap; }
    th:first-child, td:first-child { text-align:center; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    tbody tr:hover { background:#e5f2ff; }
    .col-date { min-width:90px; }
    .col-actions { min-width:160px; text-align:center; }
    .info { font-size:11px; color:#6b7280; margin-top:8px; }

    .ledger-summary-main { display:block; font-size:16px; font-weight:700; margin-bottom:6px; color:#000; }
    .ledger-summary-sub  { display:block; font-size:14px; margin-top:4px; color:#1b4ba0; }

    /* MMK lines */
    .mmk-lines-wrap { grid-column: 1 / -1; }
    .mmk-lines-list { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .mmk-line{
      display:grid;
      grid-template-columns: 140px 1fr 60px;
      gap:6px;
      align-items:end;
    }
    .mmk-line input[type="number"],
    .mmk-line input[type="text"]{
      width:100%;
      padding:6px 8px;
      font-size:13px;
      border-radius:6px;
      border:1px solid #d1d5db;
    }
    .mmk-line button{
      padding:6px 8px;
      font-size:11px;
      border-radius:6px;
    }

    /* Collapsible */
    .collapsible-body { display:none; }
    .collapsible-body.is-open { display:block; }
    .toggle-link {
      background:#e5e7eb; color:#111827;
      border:none; border-radius:8px;
      padding:6px 10px; cursor:pointer;
      font-size:12px;
    }
    .toggle-link.primary { background:#1b4ba0; color:#fff; }
  </style>

  <!-- Excel Export Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Daily Balance Database</h1>
    <p>·Äê·Äî·Ä±·Ä∑·Äê·Ä¨ ·ÄÑ·ÄΩ·Ä±·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫ + Other People Money Ledger ·ÄÄ·Ä≠·ÄØ Firebase Firestore ·Äï·Ä±·Ä´·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äñ·Ä≠·ÄØ·Ä∑ Web App</p>
  </header>

  <main>
    <!-- MAIN BALANCE FORM -->
    <section class="card">
      <h2>Daily Balance (Main)</h2>
      <small>Bank / Cash / Other Debit + MMK + Rate ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã Total / Total_Other ·ÄÄ·Ä≠·ÄØ ·Ä°·Ä±·Ä¨·Ä∫·Äê·Ä≠·ÄØ·Äê·ÄΩ·ÄÄ·Ä∫·Äï·Ä±·Ä∏·Äô·Äö·Ä∫·Åã</small>

      <form id="balanceForm">
        <label>Date <input type="date" id="date" required /></label>

        <label>YBBL <input type="number" id="YBBL" step="0.01" /></label>
        <label>YK+  <input type="number" id="YKp"  step="0.01" /></label>
        <label>YSCB <input type="number" id="YSCB" step="0.01" /></label>
        <label>YKTB <input type="number" id="YKTB" step="0.01" /></label>
        <label>YTM  <input type="number" id="YTM"  step="0.01" /></label>

        <label>HBBL <input type="number" id="HBBL" step="0.01" /></label>
        <label>HK+  <input type="number" id="HKp"  step="0.01" /></label>
        <label>HSCB <input type="number" id="HSCB" step="0.01" /></label>
        <label>HTM  <input type="number" id="HTM"  step="0.01" /></label>
        <label>TTM  <input type="number" id="TTM"  step="0.01" /></label>

        <label>Cash <input type="number" id="cash" step="0.01" /></label>
        <label>Other Debit <input type="number" id="otherDebit" step="0.01" /></label>

        <label>MMK Amount (Total)
          <input type="number" id="MMK" step="0.01" readonly />
        </label>

        <div style="display:flex; align-items:flex-end;">
          <button type="button" class="btn-secondary" id="btnAddMMKLine" style="height:32px; width:100%;">+ Add MMK</button>
        </div>

        <div class="mmk-lines-wrap">
          <div id="mmkLines" class="mmk-lines-list"></div>
          <p class="info" style="margin:8px 0 0 0;">
            * + Add MMK ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ Amount/Note row ·Äê·ÄΩ·Ä±·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã Total MMK ·ÄÄ·Ä≠·ÄØ ·Ä°·Ä±·Ä¨·Ä∫·Äê·Ä≠·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äï·Ä±·Ä∏·Äô·Äö·Ä∫·Åã
          </p>
        </div>

        <label>Rate / 100,000 MMK (ex: 820)
          <input type="number" id="rate" step="0.01" />
        </label>

        <label>Total (MMK ‚ûú THB) <input type="number" id="total" step="0.01" readonly /></label>
        <label>Total Before Other (THB) <input type="number" id="totalBeforeOther" step="0.01" readonly /></label>
        <label>Other People Money (-) <input type="number" id="minusOther" step="0.01" readonly /></label>
        <label>Total_Other (Final) <input type="number" id="totalOther" step="0.01" readonly /></label>

        <div class="btn-row" style="grid-column:1/-1;">
          <button type="submit" class="btn-primary">Save / Update</button>
          <button type="button" class="btn-secondary" id="btnClearForm">Clear Form</button>
          <button type="button" class="btn-secondary" id="btnClearAll">Clear ALL Data</button>
          <button type="button" class="btn-secondary" id="btnExport">Export JSON</button>
          <button type="button" class="btn-secondary" id="btnExportExcel">Export Excel</button>
        </div>

        <p class="info" style="grid-column:1/-1;">
          * Total(MMK‚ûúTHB)=(MMK√∑100,000)√óRate | Total_Other=Original Total‚àíOther People Money
        </p>
      </form>
    </section>

    <!-- DAILY BALANCE TABLE -->
    <section class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">Daily Balance List (From Firebase)</h2>
        <button type="button" class="toggle-link primary" id="btnToggleBalanceList">Show Table</button>
      </div>

      <div id="balanceListBody" class="collapsible-body is-open">
        <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th class="col-date">Date</th>
              <th>YBBL</th><th>YK+</th><th>YSCB</th><th>YKTB</th><th>YTM</th>
              <th>HBBL</th><th>HK+</th><th>HSCB</th><th>HTM</th><th>TTM</th>
              <th>Cash</th><th>Other Debit</th>
              <th>MMK</th><th>Rate</th>
              <th>Total (THB)</th>
              <th>Original Total</th>
              <th>Other Money (-)</th>
              <th>Total_Other</th>
              <th>Change</th>
              <th class="col-actions">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="info" id="profitSummary"></p>
      </div>
    </section>

    <!-- OTHER PEOPLE MONEY LEDGER -->
    <section class="card">
      <h2>Other People Money Ledger</h2>
      <small>
        Transaction (Date, Cash In, Cash Out, Description) ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏ Name ·Äê·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÖ·ÄÆ Running Balance ·ÄÄ·Ä≠·ÄØ·Äê·ÄΩ·ÄÄ·Ä∫·Äï·Äº·Äô·Äö·Ä∫·Åã
        <br>‚úÖ App ·Äù·ÄÑ·Ä∫·Äê·Ä¨·Äî·Ä≤·Ä∑ Firestore Rules (active) ·ÄÄ·Ä≠·ÄØ Auto Run (catch-up) ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äô·Äö·Ä∫·Åã
      </small>

      <form id="peopleForm">
        <label>Date <input type="date" id="pDate" required /></label>
        <label>Name <input type="text" id="pName" placeholder="A / Mi Htoo ..." required /></label>
        <label>Cash In <input type="number" id="pIn" step="0.01" /></label>
        <label>Cash Out <input type="number" id="pOut" step="0.01" /></label>
        <label>Description <input type="text" id="pDesc" placeholder="Sep salary / Loan / Refund ..." /></label>

        <label>Auto Cash Out Amount (THB)
          <input type="number" id="pAutoOut" step="0.01" placeholder="ex: 100" />
        </label>

        <div class="btn-row" style="grid-column:1/-1;">
          <button type="submit" class="btn-primary" id="btnSavePerson">Save Txn</button>
          <button type="button" class="btn-secondary" id="btnAutoCashOut">Auto Cash Out</button>
          <button type="button" class="btn-secondary" id="btnClearPerson">Clear Form</button>
          <button type="button" class="btn-secondary" id="btnExportLedgerJson">Export Ledger JSON</button>
          <button type="button" class="btn-secondary" id="btnExportLedgerExcel">Export Ledger Excel</button>
        </div>
      </form>

      <!-- AUTO CASH OUT RULE MANAGER (Firestore) -->
      <div class="card" style="margin-top:14px; background:#f8fafc; border:1px solid #e5e7eb;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h3 style="margin:0; font-size:16px;">Auto Cash Out Rule (Daily) ‚Äî Firestore</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="toggle-link primary" id="btnToggleRulesPanel">Hide Panel</button>
            <button type="button" class="toggle-link" id="btnToggleRulesTable">Hide Table</button>
          </div>
        </div>

        <div id="rulesBody" class="collapsible-body is-open">
          <small style="display:block; margin-bottom:10px;">
            Rule ·Äê·ÄΩ·Ä±·ÄÄ·Ä≠·ÄØ Firestore ·Äë·Ä≤·Äû·Ä≠·Äô·Ä∫·Ä∏·Äë·Ä¨·Ä∏·Äú·Ä≠·ÄØ·Ä∑ Device ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äô·Äæ·Ä¨ ·Äê·Ä∞·Äê·Ä∞·Äï·Ä±·Ä´·Ä∫·Äô·Äö·Ä∫·Åã
          </small>

          <form id="ruleForm" style="margin-bottom:10px;">
            <label>Name <input type="text" id="rName" placeholder="A / Mi Htoo ..." required /></label>
            <label>Amount / Day (THB) <input type="number" id="rAmount" step="0.01" placeholder="100" required /></label>
            <label>Start Date <input type="date" id="rStart" required /></label>
            <label>End Date (optional) <input type="date" id="rEnd" /></label>

            <div class="btn-row" style="grid-column:1/-1;">
              <button type="submit" class="btn-primary" id="btnSaveRule">Save Rule</button>
              <button type="button" class="btn-secondary" id="btnRunRulesNow">Run Rules Now</button>
              <button type="button" class="btn-secondary" id="btnClearRuleForm">Clear</button>
            </div>

            <p class="info" id="ruleMsg" style="grid-column:1/-1; margin-top:6px;"></p>
          </form>

          <div id="rulesTableWrap" class="collapsible-body is-open">
            <div class="table-container" style="max-height:220px;">
              <table id="rulesTable" style="min-width:900px;">
                <thead>
                  <tr>
                    <th style="text-align:left;">Name</th>
                    <th>Amount/Day</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Active</th>
                    <th>Last Run</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <p class="info" style="margin-top:8px;">
              * Active=YES ·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä≤·Ä∑ Rule ·Äê·ÄΩ·Ä±·ÄÄ·Äï·Ä≤ Auto run ·Äï·Ä´·Äô·Äö·Ä∫·Åã Balance 0 ·Äñ·Äº·ÄÖ·Ä∫·Äõ·ÄÑ·Ä∫ auto stop ·Äñ·Äº·ÄÖ·Ä∫·Äô·Äö·Ä∫·Åã
            </p>
          </div>
        </div>
      </div>

      <!-- Filter -->
      <div class="btn-row" style="margin-top:12px; margin-bottom:4px;">
        <label style="flex:0 0 220px; font-size:13px;">
          Filter by Name
          <select id="personFilter"><option value="">All</option></select>
        </label>
      </div>

      <div class="table-container">
        <table id="peopleTable" style="min-width:900px;">
          <thead>
            <tr>
              <th>Date</th>
              <th style="text-align:left;">Name</th>
              <th style="text-align:left;">Description</th>
              <th>Cash In</th>
              <th>Cash Out</th>
              <th>Balance (Per Name)</th>
              <th class="col-actions">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="info">
        <span class="ledger-summary-main">
          üë§ Selected Person Balance: <span id="ledgerSelectedBalance">All persons</span>
        </span>
        <span class="ledger-summary-sub">
          üí∞ Total Other People Money (All): <span id="ledgerTotalAll">0.00</span>
        </span>
      </p>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      setDoc,
      doc,
      deleteDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVcVbBPs8s9vifCkfojuMXXykOOblsWBM",
      authDomain: "balanceylh.firebaseapp.com",
      projectId: "balanceylh",
      storageBucket: "balanceylh.firebasestorage.app",
      messagingSenderId: "338276543010",
      appId: "1:338276543010:web:f9cb384af5387a7ca0b87b",
      measurementId: "G-6QNSRHQ9FE"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // =========================================================
    // ‚úÖ RULES: Firestore collection
    // =========================================================
    const RULES_COLL = "auto_cashout_rules";   // <--- rules stored here
    const RULES_PANEL_KEY = "RULES_PANEL_COLLAPSED_V1";
    const RULES_TABLE_KEY = "RULES_TABLE_COLLAPSED_V1";
    const BAL_LIST_KEY  = "BAL_LIST_COLLAPSED_V1";
    let fsRules = []; // [{id, ...data}]
    let editingRuleId = null;

    async function fetchAllRules() {
      const snap = await getDocs(collection(db, RULES_COLL));
      const list = [];
      snap.forEach(d => list.push({ id: d.id, ...d.data() }));
      // sort by name
      list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      fsRules = list;
      return list;
    }

    async function saveRuleToFirestore(rule) {
      // new rule
      if (!editingRuleId) {
        await addDoc(collection(db, RULES_COLL), {
          ...rule,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      } else {
        await updateDoc(doc(db, RULES_COLL, editingRuleId), {
          ...rule,
          updatedAt: serverTimestamp()
        });
      }
    }

    async function deleteRuleFromFirestore(id) {
      await deleteDoc(doc(db, RULES_COLL, id));
    }

    async function toggleRuleActive(id, active) {
      await updateDoc(doc(db, RULES_COLL, id), { active, updatedAt: serverTimestamp() });
    }

    async function updateRuleLastRun(id, isoDate) {
      await updateDoc(doc(db, RULES_COLL, id), { lastRunDate: isoDate, updatedAt: serverTimestamp() });
    }
    // =========================================================

    // -------- Helpers --------
    function numFrom(id) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? 0 : v;
    }
    function format2(value) {
      if (value === null || value === undefined || isNaN(value)) return "";
      return Number(value).toFixed(2);
    }
    function round2(value) {
      if (value === null || value === undefined || isNaN(value)) return 0;
      return Number(Number(value).toFixed(2));
    }
    function isoToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function addDays(iso, days) {
      const d = new Date(iso + "T00:00:00");
      d.setDate(d.getDate() + days);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setRuleMsg(text) {
      const el = document.getElementById("ruleMsg");
      if (el) el.textContent = text || "";
    }

    function setCollapsed(elId, btnId, collapsed, showText="Show", hideText="Hide") {
      const el = document.getElementById(elId);
      const btn = document.getElementById(btnId);
      if (!el || !btn) return;
      if (collapsed) { el.classList.remove("is-open"); btn.textContent = showText; }
      else { el.classList.add("is-open"); btn.textContent = hideText; }
    }
    function setPanelCollapsed(collapsed) {
      setCollapsed("rulesBody","btnToggleRulesPanel",collapsed,"Show Panel","Hide Panel");
      localStorage.setItem(RULES_PANEL_KEY, collapsed ? "1" : "0");
    }
    function setTableCollapsed(collapsed) {
      setCollapsed("rulesTableWrap","btnToggleRulesTable",collapsed,"Show Table","Hide Table");
      localStorage.setItem(RULES_TABLE_KEY, collapsed ? "1" : "0");
    }

    function setBalanceListCollapsed(collapsed) {
      setCollapsed("balanceListBody","btnToggleBalanceList",collapsed,"Show Table","Hide Table");
      localStorage.setItem(BAL_LIST_KEY, collapsed ? "1" : "0");
    }

    // -------- MMK rows (+) --------
    let mmkItems = []; // [{amount:""|number, note:string}]

    function syncMMKTotal(recalcAfter = true) {
      const total = mmkItems.reduce((s, it) => s + (parseFloat(it.amount) || 0), 0);
      document.getElementById("MMK").value = format2(round2(total));
      if (recalcAfter) recalc();
    }

    function renderMMKLines() {
      const wrap = document.getElementById("mmkLines");
      wrap.innerHTML = "";

      if (mmkItems.length === 0) {
        const hint = document.createElement("div");
        hint.className = "info";
        hint.textContent = "MMK row ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´ ‚Äî + Add MMK ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã";
        wrap.appendChild(hint);
        document.getElementById("MMK").value = format2(0);
        return;
      }

      mmkItems.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "mmk-line";

        const inpAmt = document.createElement("input");
        inpAmt.type = "number";
        inpAmt.step = "0.01";
        inpAmt.placeholder = "MMK";
        inpAmt.value = (it.amount ?? "");
        inpAmt.oninput = () => {
          const raw = inpAmt.value;
          mmkItems[idx].amount = raw === "" ? "" : (parseFloat(raw) || 0);
          syncMMKTotal();
        };

        const inpNote = document.createElement("input");
        inpNote.type = "text";
        inpNote.placeholder = "Note";
        inpNote.value = (it.note ?? "");
        inpNote.oninput = () => { mmkItems[idx].note = inpNote.value; };

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "btn-danger btn-small";
        btnDel.textContent = "Del";
        btnDel.onclick = () => {
          mmkItems.splice(idx, 1);
          renderMMKLines();
          syncMMKTotal();
        };

        row.appendChild(inpAmt);
        row.appendChild(inpNote);
        row.appendChild(btnDel);
        wrap.appendChild(row);
      });

      syncMMKTotal(false);
    }

    // -------- Main balance calc --------
    function recalc() {
      const bankFields = [
        "YBBL","YKp","YSCB","YKTB","YTM",
        "HBBL","HKp","HSCB","HTM","TTM",
        "cash","otherDebit"
      ];
      let sumTHB = 0;
      bankFields.forEach(id => { sumTHB += numFrom(id); });

      const mmk  = numFrom("MMK");
      const rate = numFrom("rate");

      let totalFromMMK = 0;
      if (mmk !== 0 && rate !== 0) totalFromMMK = (mmk / 100000) * rate;

      const totalFromMMK2 = round2(totalFromMMK);
      document.getElementById("total").value = format2(totalFromMMK2);

      const totalAll = round2(sumTHB + totalFromMMK2);
      document.getElementById("totalBeforeOther").value = format2(totalAll);

      const minusOther = numFrom("minusOther");
      const finalTotal = round2(totalAll - minusOther);
      document.getElementById("totalOther").value = format2(finalTotal);
    }

    function getFormData() {
      return {
        date: document.getElementById("date").value,
        YBBL: round2(numFrom("YBBL")),
        YKp: round2(numFrom("YKp")),
        YSCB: round2(numFrom("YSCB")),
        YKTB: round2(numFrom("YKTB")),
        YTM: round2(numFrom("YTM")),
        HBBL: round2(numFrom("HBBL")),
        HKp: round2(numFrom("HKp")),
        HSCB: round2(numFrom("HSCB")),
        HTM: round2(numFrom("HTM")),
        TTM: round2(numFrom("TTM")),
        cash: round2(numFrom("cash")),
        otherDebit: round2(numFrom("otherDebit")),
        MMK: round2(numFrom("MMK")),
        rate: round2(numFrom("rate")),
        total: round2(numFrom("total")),
        totalBeforeOther: round2(numFrom("totalBeforeOther")),
        minusOther: round2(numFrom("minusOther")),
        totalOther: round2(numFrom("totalOther")),
        mmkItems: mmkItems.map(x => ({
          amount: x.amount === "" ? "" : round2(parseFloat(x.amount) || 0),
          note: (x.note || "").trim()
        }))
      };
    }

    function clearForm() {
      document.getElementById("balanceForm").reset();
      mmkItems = [];
      renderMMKLines();
      syncMMKTotal();
      recalc();
      editingBalanceId = null;
      const submitBtn = document.querySelector('#balanceForm button[type="submit"]');
      if (submitBtn) submitBtn.textContent = 'Save';

    }

    // -------- Firestore: daily_balance --------
    let editingBalanceId = null;
    async function fetchAllBalances() {
      try {
        const snap = await getDocs(collection(db, "daily_balance"));
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        return list;
      } catch (err) {
        console.warn("fetchAllBalances error:", err.message);
        return [];
      }
    }
    async function saveBalanceDoc(data) {
      if (editingBalanceId) {
        await setDoc(doc(db, "daily_balance", editingBalanceId), data);
      } else {
        await addDoc(collection(db, "daily_balance"), data);
      }
    }
    async function deleteBalance(id) { await deleteDoc(doc(db, "daily_balance", id)); }
    async function clearAllBalanceDocs() {
      const snap = await getDocs(collection(db, "daily_balance"));
      const tasks = [];
      snap.forEach(d => tasks.push(deleteDoc(d.ref)));
      await Promise.all(tasks);
    }

    async function renderBalanceTable() {
      const data = await fetchAllBalances();
      data.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      let prevTotal = null;
      let startBalance = null;
      let lastBalance  = null;

      data.forEach(row => {
        const bankFields = [
          "YBBL","YKp","YSCB","YKTB","YTM",
          "HBBL","HKp","HSCB","HTM","TTM",
          "cash","otherDebit"
        ];
        let sumTHB = 0;
        bankFields.forEach(id => { sumTHB += (row[id] || 0); });

        const totalFromMMK = row.total || 0;
        const originalTotal =
          (typeof row.totalBeforeOther === "number") ? row.totalBeforeOther : round2(sumTHB + totalFromMMK);

        const tr = document.createElement("tr");
        const keys = [
          "date","YBBL","YKp","YSCB","YKTB","YTM","HBBL","HKp","HSCB","HTM","TTM",
          "cash","otherDebit","MMK","rate","total"
        ];
        keys.forEach(key => {
          const td = document.createElement("td");
          const v  = row[key];
          if (key === "date") { td.textContent = v || ""; td.style.textAlign = "center"; }
          else { td.textContent = (v === undefined || v === null || v === "") ? "" : format2(v); }
          tr.appendChild(td);
        });

        const tdOrig = document.createElement("td");
        tdOrig.textContent = format2(originalTotal);
        tr.appendChild(tdOrig);

        const tdMinus = document.createElement("td");
        tdMinus.textContent = (row.minusOther === undefined || row.minusOther === null) ? "" : format2(row.minusOther);
        tr.appendChild(tdMinus);

        const tdTotalOther = document.createElement("td");
        tdTotalOther.textContent = (row.totalOther === undefined || row.totalOther === null) ? "" : format2(row.totalOther);
        tr.appendChild(tdTotalOther);

        const tdChange = document.createElement("td");
        let diffText = "";
        if (typeof row.totalOther === "number" && !isNaN(row.totalOther)) {
          if (prevTotal !== null) {
            const diff = row.totalOther - prevTotal;
            diffText = diff === 0 ? "" : format2(diff);
          }
          prevTotal = row.totalOther;
          if (startBalance === null) startBalance = row.totalOther;
          lastBalance = row.totalOther;
        }
        tdChange.textContent = diffText;
        tr.appendChild(tdChange);

        const tdAction = document.createElement("td");
        tdAction.className = "col-actions";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Edit";
        btnEdit.className = "btn-small btn-secondary";
        btnEdit.onclick = () => {
          // Fill main balance form for editing
          document.getElementById("date").value = row.date || isoToday();

          const mapIds = ["YBBL","YKp","YSCB","YKTB","YTM","HBBL","HKp","HSCB","HTM","TTM","cash","otherDebit","rate"];
          mapIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const v = row[id];
            el.value = (v === undefined || v === null || v === 0) ? (v === 0 ? "0" : "") : String(v);
          });

          // Restore MMK line items if available
          if (Array.isArray(row.mmkItems)) {
            mmkItems = row.mmkItems.map(x => ({
              amount: (x && x.amount !== undefined && x.amount !== null) ? String(x.amount) : "",
              note: (x && x.note) ? String(x.note) : ""
            }));
          } else {
            mmkItems = [];
          }
          renderMMKLines();
          syncMMKTotal();

          recalc();

          editingBalanceId = row.id;
          const submitBtn = document.querySelector('#balanceForm button[type="submit"]');
          if (submitBtn) submitBtn.textContent = "Update";

          window.scrollTo({ top: document.getElementById("balanceForm").getBoundingClientRect().top + window.scrollY - 20, behavior: "smooth" });
        };

        const btnDel = document.createElement("button");
        btnDel.textContent = "Delete";
        btnDel.className = "btn-small btn-danger";
        btnDel.onclick = async () => {
          if (!confirm("Delete record for " + (row.date || "") + " ?")) return;
          await deleteBalance(row.id);
          await renderBalanceTable();
          alert("Deleted ‚úî");
        };
        tdAction.appendChild(btnEdit);
        tdAction.appendChild(btnDel);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });

      const summary = document.getElementById("profitSummary");
      if (startBalance !== null && lastBalance !== null) {
        const profit = lastBalance - startBalance;
        summary.textContent = `Start: ${format2(startBalance)} | Latest: ${format2(lastBalance)} | P/L: ${format2(profit)}`;
      } else summary.textContent = "No balance data yet.";
    }

    // -------- Ledger: other_people_txn --------
    let editingTxnId = null;
    let editingTxnExtra = null;
    let lastBalanceByNameCache = {};

    async function fetchAllPeopleTxns() {
      try {
        const snap = await getDocs(collection(db, "other_people_txn"));
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        return list;
      } catch (err) {
        console.warn("fetchAllPeopleTxns error:", err.message);
        return [];
      }
    }

    async function savePersonTxn(txn) {
      if (editingTxnId) await setDoc(doc(db, "other_people_txn", editingTxnId), txn);
      else await addDoc(collection(db, "other_people_txn"), txn);
    }

    async function deletePersonTxn(id) { await deleteDoc(doc(db, "other_people_txn", id)); }

    function clearPersonForm() {
      document.getElementById("peopleForm").reset();
      editingTxnId = null;
      editingTxnExtra = null;
      document.getElementById("btnSavePerson").textContent = "Save Txn";
    }

    async function renderPeopleTableAndUpdateMinus(selectedName) {
      const data = await fetchAllPeopleTxns();

      const filterSelect = document.getElementById("personFilter");
      const currentFilter = (selectedName !== undefined) ? selectedName : (filterSelect.value || "");

      const namesSet = new Set();
      data.forEach(txn => { if (txn.name) namesSet.add(txn.name); });
      filterSelect.innerHTML = '<option value="">All</option>';
      Array.from(namesSet).sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (name === currentFilter) opt.selected = true;
        filterSelect.appendChild(opt);
      });

      data.sort((a,b)=> {
        const n1 = (a.name || "").localeCompare(b.name || "");
        if (n1 !== 0) return n1;
        return (a.date || "").localeCompare(b.date || "");
      });

      const tbody = document.querySelector("#peopleTable tbody");
      tbody.innerHTML = "";

      const balancesByName = {};
      const lastBalanceByName = {};

      data.forEach(txn => {
        const name = txn.name || "";
        const cin  = txn.cashIn  || 0;
        const cout = txn.cashOut || 0;

        if (!(name in balancesByName)) balancesByName[name] = 0;
        balancesByName[name] += cin - cout;
        const bal = balancesByName[name];
        lastBalanceByName[name] = bal;

        if (currentFilter && name !== currentFilter) return;

        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = txn.date || "";
        tdDate.style.textAlign = "center";
        tr.appendChild(tdDate);

        const tdName = document.createElement("td");
        tdName.textContent = name;
        tdName.style.textAlign = "left";
        tr.appendChild(tdName);

        const tdDesc = document.createElement("td");
        tdDesc.textContent = txn.desc || "";
        tdDesc.style.textAlign = "left";
        tr.appendChild(tdDesc);

        const tdIn = document.createElement("td");
        tdIn.textContent = (txn.cashIn ?? 0) === 0 ? "" : txn.cashIn;
        tr.appendChild(tdIn);

        const tdOut = document.createElement("td");
        tdOut.textContent = (txn.cashOut ?? 0) === 0 ? "" : txn.cashOut;
        tr.appendChild(tdOut);

        const tdBal = document.createElement("td");
        tdBal.textContent = format2(bal);
        tr.appendChild(tdBal);

        const tdAction = document.createElement("td");
        tdAction.className = "col-actions";

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Edit";
        btnEdit.className = "btn-small btn-secondary";
        btnEdit.onclick = () => {
          document.getElementById("pDate").value = txn.date || isoToday();
          document.getElementById("pName").value = name;
          document.getElementById("pIn").value   = (txn.cashIn  ?? 0) ? txn.cashIn  : "";
          document.getElementById("pOut").value  = (txn.cashOut ?? 0) ? txn.cashOut : "";
          document.getElementById("pDesc").value = txn.desc || "";

          editingTxnId = txn.id;
          editingTxnExtra = {};
          if (txn.isAuto !== undefined) editingTxnExtra.isAuto = txn.isAuto;
          if (txn.autoDate) editingTxnExtra.autoDate = txn.autoDate;
          if (txn.autoRuleId) editingTxnExtra.autoRuleId = txn.autoRuleId;

          document.getElementById("btnSavePerson").textContent = "Update Txn";
          window.scrollTo({ top: document.getElementById("peopleForm").getBoundingClientRect().top + window.scrollY - 20, behavior: "smooth" });
        };

        const btnDel = document.createElement("button");
        btnDel.textContent = "Delete";
        btnDel.className = "btn-small btn-danger";
        btnDel.onclick = async () => {
          if (!confirm("Delete this transaction for " + name + " ?")) return;
          await deletePersonTxn(txn.id);
          await renderPeopleTableAndUpdateMinus(currentFilter);
          alert("Deleted ‚úî");
        };

        tdAction.appendChild(btnEdit);
        tdAction.appendChild(btnDel);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });

      lastBalanceByNameCache = lastBalanceByName;

      let sumOther = 0;
      Object.values(lastBalanceByName).forEach(v => { sumOther += v; });
      document.getElementById("minusOther").value = format2(sumOther);
      recalc();

      document.getElementById("ledgerTotalAll").textContent = format2(sumOther);

      let selectedBalanceText = "-";
      if (currentFilter && lastBalanceByName[currentFilter] !== undefined) {
        selectedBalanceText = `${currentFilter} : ${format2(lastBalanceByName[currentFilter])} ·Äò·Äê·Ä∫`;
      } else if (!currentFilter) selectedBalanceText = "All persons";
      document.getElementById("ledgerSelectedBalance").textContent = selectedBalanceText;
    }

    // -------- Ledger export --------
    async function exportLedgerJson() {
      const data = await fetchAllPeopleTxns();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url;
      a.download = "other_people_ledger.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function exportLedgerExcel() {
      if (typeof XLSX === "undefined") { alert("Excel library ·Äô·Äê·ÄÑ·Ä∫·Äõ·Äû·Ä±·Ä∏·Äï·Ä´"); return; }
      const data = await fetchAllPeopleTxns();
      if (!data.length) { alert("Ledger data ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´"); return; }

      data.sort((a,b)=> {
        const n1 = (a.name || "").localeCompare(b.name || "");
        if (n1 !== 0) return n1;
        return (a.date || "").localeCompare(b.date || "");
      });

      const balancesByName = {};
      const rows = [["Date","Name","Description","Cash In","Cash Out","Balance (Per Name)"]];

      data.forEach(txn => {
        const name = txn.name || "";
        const cin  = txn.cashIn  || 0;
        const cout = txn.cashOut || 0;

        if (!(name in balancesByName)) balancesByName[name] = 0;
        balancesByName[name] += cin - cout;

        rows.push([ txn.date || "", name, txn.desc || "", round2(cin), round2(cout), round2(balancesByName[name]) ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ledger");
      XLSX.writeFile(wb, "other_people_ledger.xlsx");
    }

    // -------- Manual Auto Cash Out (partial) --------
    async function autoCashOutAndSave() {
      const name = document.getElementById("pName").value.trim() || (document.getElementById("personFilter").value || "");
      if (!name) { alert("Name ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ (·Äû·Ä≠·ÄØ·Ä∑) Filter ·Äô·Äæ·Ä¨ Name ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´"); return; }

      const bal = lastBalanceByNameCache[name];
      if (bal === undefined) { alert(`"${name}" ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Ledger data ·Äô·Äê·ÄΩ·Ä±·Ä∑·Äï·Ä´`); return; }
      if (!(bal > 0)) { alert(`"${name}" Balance = ${format2(bal)} ·Äñ·Äº·ÄÖ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ Cash Out ·Äô·Äú·ÄØ·Äï·Ä∫·Äï·Ä´`); return; }

      let date = document.getElementById("pDate").value || isoToday();
      document.getElementById("pDate").value = date;

      const req = parseFloat(document.getElementById("pAutoOut").value);
      if (isNaN(req) || req <= 0) { alert("Auto Cash Out Amount ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨ 100)"); return; }

      const pay = Math.min(req, bal);

      await addDoc(collection(db, "other_people_txn"), {
        date, name,
        cashIn: 0,
        cashOut: round2(pay),
        desc: `Auto Cash Out (${format2(pay)} of ${format2(bal)})`,
        isAuto: false
      });

      await renderPeopleTableAndUpdateMinus(document.getElementById("personFilter").value || "");
      alert(`Auto Cash Out Saved ‚úî  ${name} - ${format2(pay)} ‡∏ö‡∏≤‡∏ó`);
    }

    // =========================================================
    // ‚úÖ RULE UI (Firestore)
    // =========================================================
    function fillRuleForm(r) {
      document.getElementById("rName").value = r.name || "";
      document.getElementById("rAmount").value = r.amountPerDay ?? "";
      document.getElementById("rStart").value = r.startDate || "";
      document.getElementById("rEnd").value = r.endDate || "";
      editingRuleId = r.id;
      document.getElementById("btnSaveRule").textContent = "Update Rule";
      setRuleMsg("");
    }

    function clearRuleForm() {
      document.getElementById("ruleForm").reset();
      editingRuleId = null;
      document.getElementById("btnSaveRule").textContent = "Save Rule";
      setRuleMsg("");
    }

    async function renderRulesTableFromFS() {
      await fetchAllRules();
      const tbody = document.querySelector("#rulesTable tbody");
      tbody.innerHTML = "";

      fsRules.forEach(r => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = r.name || "";
        tdName.style.textAlign = "left";
        tr.appendChild(tdName);

        const tdAmt = document.createElement("td");
        tdAmt.textContent = format2(r.amountPerDay || 0);
        tr.appendChild(tdAmt);

        const tdStart = document.createElement("td");
        tdStart.textContent = r.startDate || "";
        tdStart.style.textAlign = "center";
        tr.appendChild(tdStart);

        const tdEnd = document.createElement("td");
        tdEnd.textContent = r.endDate || "";
        tdEnd.style.textAlign = "center";
        tr.appendChild(tdEnd);

        const tdActive = document.createElement("td");
        tdActive.textContent = r.active ? "YES" : "NO";
        tdActive.style.textAlign = "center";
        tr.appendChild(tdActive);

        const tdLast = document.createElement("td");
        tdLast.textContent = r.lastRunDate || "";
        tdLast.style.textAlign = "center";
        tr.appendChild(tdLast);

        const tdAct = document.createElement("td");
        tdAct.className = "col-actions";

        const btnLoad = document.createElement("button");
        btnLoad.type = "button";
        btnLoad.className = "btn-small btn-secondary";
        btnLoad.textContent = "Load";
        btnLoad.onclick = () => fillRuleForm(r);

        const btnToggle = document.createElement("button");
        btnToggle.type = "button";
        btnToggle.className = "btn-small btn-secondary";
        btnToggle.style.marginLeft = "4px";
        btnToggle.textContent = r.active ? "Stop" : "Start";
        btnToggle.onclick = async () => {
          await toggleRuleActive(r.id, !r.active);
          await renderRulesTableFromFS();
        };

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "btn-small btn-danger";
        btnDel.style.marginLeft = "4px";
        btnDel.textContent = "Delete";
        btnDel.onclick = async () => {
          if (!confirm(`Delete rule for ${r.name}?`)) return;
          await deleteRuleFromFirestore(r.id);
          if (editingRuleId === r.id) clearRuleForm();
          await renderRulesTableFromFS();
        };

        tdAct.appendChild(btnLoad);
        tdAct.appendChild(btnToggle);
        tdAct.appendChild(btnDel);

        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
    }

    // =========================================================
    // ‚úÖ AUTO RUN based on Firestore rules
    // - prevents duplicates using (isAuto=true + autoRuleId + autoDate)
    // =========================================================
    async function runFirestoreRulesCatchUp(showMsg=false) {
      await fetchAllRules();
      const activeRules = fsRules.filter(r => r.active);

      if (!activeRules.length) {
        if (showMsg) setRuleMsg("No active rules to run.");
        return;
      }

      const today = isoToday();
      const txns = await fetchAllPeopleTxns();

      const netByNameByDate = {};
      const earliestByName = {};
      const autoKeySet = new Set(); // `${ruleId}_${date}`

      for (const t of txns) {
        const name = (t.name || "").trim();
        const date = t.date || "";
        if (!name || !date) continue;

        const cin = Number(t.cashIn || 0) || 0;
        const cout = Number(t.cashOut || 0) || 0;

        if (!netByNameByDate[name]) netByNameByDate[name] = {};
        netByNameByDate[name][date] = (netByNameByDate[name][date] || 0) + (cin - cout);

        if (!earliestByName[name] || date < earliestByName[name]) earliestByName[name] = date;

        if (t.isAuto && t.autoRuleId && t.autoDate) {
          autoKeySet.add(`${t.autoRuleId}_${t.autoDate}`);
        }
      }

      let created = 0;
      let stopped = 0;

      for (const r of activeRules) {
        const name = (r.name || "").trim();
        const perDay = Number(r.amountPerDay || 0);
        const start = r.startDate || today;
        const end = (r.endDate || "").trim();

        if (!name || !isFinite(perDay) || perDay <= 0) continue;

        const to = end ? (end < today ? end : today) : today;

        const simStart = earliestByName[name]
          ? (earliestByName[name] < start ? earliestByName[name] : start)
          : start;

        let bal = 0;
        let d = simStart;

        while (d <= to) {
          const dayNet = (netByNameByDate[name] && netByNameByDate[name][d]) ? netByNameByDate[name][d] : 0;
          bal += dayNet;

          if (d >= start && d <= to) {
            if (bal <= 0) {
              await toggleRuleActive(r.id, false);
              stopped++;
              break;
            }

            const key = `${r.id}_${d}`;
            if (!autoKeySet.has(key)) {
              const pay = Math.min(perDay, bal);

              await addDoc(collection(db, "other_people_txn"), {
                date: d,
                name,
                cashIn: 0,
                cashOut: round2(pay),
                desc: `Auto Cash Out ${format2(pay)} (Rule)`,
                isAuto: true,
                autoDate: d,
                autoRuleId: r.id
              });

              created++;
              bal -= pay;

              autoKeySet.add(key);
              if (!netByNameByDate[name]) netByNameByDate[name] = {};
              netByNameByDate[name][d] = (netByNameByDate[name][d] || 0) - pay;
            }
          }

          d = addDays(d, 1);
        }

        // update last run
        await updateRuleLastRun(r.id, today);

        if (end && to === end) {
          await toggleRuleActive(r.id, false);
          stopped++;
        }
      }

      if (created > 0) await renderPeopleTableAndUpdateMinus(document.getElementById("personFilter").value || "");
      await renderRulesTableFromFS();

      if (showMsg) setRuleMsg(`Done ‚úì Created: ${created} txn | Stopped: ${stopped} rule(s)`);
    }

    // -------- Export Daily Balance Excel (same as before) --------
    async function exportBalancesExcel() {
      if (typeof XLSX === "undefined") { alert("Excel library ·Äô·Äê·ÄÑ·Ä∫·Äõ·Äû·Ä±·Ä∏·Äï·Ä´"); return; }
      const data = await fetchAllBalances();
      if (!data.length) { alert("Daily balance data ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´"); return; }
      data.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));
      let prevTotal = null;

      const rows = [];
      rows.push([
        "Date","YBBL","YK+","YSCB","YKTB","YTM",
        "HBBL","HK+","HSCB","HTM","TTM",
        "Cash","Other Debit","MMK","Rate",
        "Total (THB)","Original Total","Other Money (-)","Total_Other","Change"
      ]);

      data.forEach(row => {
        const bankFields = ["YBBL","YKp","YSCB","YKTB","YTM","HBBL","HKp","HSCB","HTM","TTM","cash","otherDebit"];
        let sumTHB = 0; bankFields.forEach(id => { sumTHB += (row[id] || 0); });

        const totalFromMMK = row.total || 0;
        const originalTotal = (typeof row.totalBeforeOther === "number") ? row.totalBeforeOther : round2(sumTHB + totalFromMMK);

        let change = "";
        if (typeof row.totalOther === "number" && !isNaN(row.totalOther)) {
          if (prevTotal !== null) {
            const diff = row.totalOther - prevTotal;
            change = diff === 0 ? "" : format2(diff);
          }
          prevTotal = row.totalOther;
        }

        rows.push([
          row.date || "",
          round2(row.YBBL || 0),
          round2(row.YKp  || 0),
          round2(row.YSCB || 0),
          round2(row.YKTB || 0),
          round2(row.YTM  || 0),
          round2(row.HBBL || 0),
          round2(row.HKp  || 0),
          round2(row.HSCB || 0),
          round2(row.HTM  || 0),
          round2(row.TTM  || 0),
          round2(row.cash || 0),
          round2(row.otherDebit || 0),
          round2(row.MMK || 0),
          round2(row.rate || 0),
          round2(row.total || 0),
          round2(originalTotal),
          round2(row.minusOther || 0),
          round2(row.totalOther || 0),
          change === "" ? "" : round2(parseFloat(change))
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DailyBalance");
      XLSX.writeFile(wb, "daily_balance.xlsx");
    }

    // -------- Events --------
    document.getElementById("btnAddMMKLine").addEventListener("click", () => {
      mmkItems.push({ amount: "", note: "" });
      renderMMKLines();
      syncMMKTotal();
    });

    ["YBBL","YKp","YSCB","YKTB","YTM","HBBL","HKp","HSCB","HTM","TTM","cash","otherDebit","rate"]
      .forEach(id => document.getElementById(id).addEventListener("input", recalc));

    document.getElementById("balanceForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const wasEditing = !!editingBalanceId;
      recalc();
      const data = getFormData();
      if (!data.date) { alert("Date ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      await saveBalanceDoc(data);
      await renderBalanceTable();
      if (wasEditing) {
        alert("Updated ‚úî");
      } else {
        alert("Saved ‚úî");
      }
      // After save/update, clear edit mode but keep table state
      clearForm();
    });

    document.getElementById("btnClearForm").addEventListener("click", clearForm);

    document.getElementById("btnClearAll").addEventListener("click", async () => {
      if (!confirm("daily_balance collection ·Äë·Ä≤·ÄÄ Data ·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äú·Ä¨·Ä∏?")) return;
      await clearAllBalanceDocs();
      await renderBalanceTable();
      alert("All daily balance data cleared ‚úî");
    });

    document.getElementById("btnExport").addEventListener("click", async () => {
      const data = await fetchAllBalances();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url;
      a.download = "daily-balance-data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById("btnExportExcel").addEventListener("click", exportBalancesExcel);

    document.getElementById("peopleForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const wasEditing = !!editingTxnId;

      const date = document.getElementById("pDate").value;
      const name = document.getElementById("pName").value.trim();
      const cashIn  = parseFloat(document.getElementById("pIn").value)  || 0;
      const cashOut = parseFloat(document.getElementById("pOut").value) || 0;
      const desc    = document.getElementById("pDesc").value.trim();

      if (!date) { alert("Ledger Date ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      if (!name) { alert("Name ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      if (cashIn === 0 && cashOut === 0) { alert("Cash In ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ Cash Out ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·ÄÅ·ÄØ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }

      const txn = { date, name, cashIn, cashOut, desc };

      // keep auto flags if editing an auto txn (so rules duplicate prevention won't break)
      if (editingTxnExtra) Object.assign(txn, editingTxnExtra);

      await savePersonTxn(txn);

      clearPersonForm();
      await renderPeopleTableAndUpdateMinus(document.getElementById("personFilter").value || "");
      alert(wasEditing ? "Transaction updated ‚úî" : "Transaction saved ‚úî");
    });

    document.getElementById("btnAutoCashOut").addEventListener("click", autoCashOutAndSave);
    document.getElementById("btnClearPerson").addEventListener("click", clearPersonForm);
    document.getElementById("btnExportLedgerJson").addEventListener("click", exportLedgerJson);
    document.getElementById("btnExportLedgerExcel").addEventListener("click", exportLedgerExcel);

    document.getElementById("personFilter").addEventListener("change", (e) => {
      renderPeopleTableAndUpdateMinus(e.target.value);
    });

    // Rule form submit (Firestore)
    document.getElementById("ruleForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name  = document.getElementById("rName").value.trim();
      const amt   = parseFloat(document.getElementById("rAmount").value);
      const start = document.getElementById("rStart").value;
      const end   = document.getElementById("rEnd").value;

      if (!name) { alert("Rule Name ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      if (isNaN(amt) || amt <= 0) { alert("Amount/Day ·ÄÄ·Ä≠·ÄØ 0 ·Äë·ÄÄ·Ä∫·ÄÄ·Äº·ÄÆ·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      if (!start) { alert("Start Date ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´"); return; }
      if (end && end < start) { alert("End Date ·ÄÄ Start Date ·Äë·ÄÄ·Ä∫·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äñ·Äº·ÄÖ·Ä∫·Äõ·Äô·Äö·Ä∫"); return; }

      await saveRuleToFirestore({
        name,
        amountPerDay: round2(amt),
        startDate: start,
        endDate: end || "",
        active: true
      });

      editingRuleId = null;
      document.getElementById("btnSaveRule").textContent = "Save Rule";
      document.getElementById("ruleForm").reset();
      document.getElementById("rStart").value = isoToday();

      await renderRulesTableFromFS();
      setRuleMsg("Saved ‚úì (Firestore)");
    });

    document.getElementById("btnClearRuleForm").addEventListener("click", () => {
      editingRuleId = null;
      document.getElementById("btnSaveRule").textContent = "Save Rule";
      document.getElementById("ruleForm").reset();
      document.getElementById("rStart").value = isoToday();
      setRuleMsg("");
    });

    document.getElementById("btnRunRulesNow").addEventListener("click", async () => {
      await runFirestoreRulesCatchUp(true);
    });

    // Panel/Table hide
    document.getElementById("btnToggleRulesPanel").addEventListener("click", () => {
      const body = document.getElementById("rulesBody");
      setPanelCollapsed(body.classList.contains("is-open"));
    });
    document.getElementById("btnToggleRulesTable").addEventListener("click", () => {
      const body = document.getElementById("rulesTableWrap");
      setTableCollapsed(body.classList.contains("is-open"));
    });

    
    // Daily Balance List hide
    document.getElementById("btnToggleBalanceList").addEventListener("click", () => {
      const body = document.getElementById("balanceListBody");
      setBalanceListCollapsed(body.classList.contains("is-open"));
    });

// -------- Init --------
    (async () => {
      try {
        document.getElementById("date").value = isoToday();
        document.getElementById("pDate").value = isoToday();
        document.getElementById("rStart").value = isoToday();

        recalc();
        renderMMKLines();
        syncMMKTotal(false);

        await renderBalanceTable();
        await renderPeopleTableAndUpdateMinus("");

        await renderRulesTableFromFS();

        // default: auto hide panels on open
        setBalanceListCollapsed(true);
        setPanelCollapsed(true);
        setTableCollapsed(true);

        // ‚úÖ App ·Äù·ÄÑ·Ä∫·Äê·Ä¨·Äî·Ä≤·Ä∑ Auto run (Firestore rules)
        await runFirestoreRulesCatchUp(false);

        console.log("Firebase connected & data loaded.");
      } catch (err) {
        console.error("Init error:", err);
        alert("Firebase connection / rules error ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äê·Ä¨·Äú·Ä≠·ÄØ ‚Äì console ·ÄÄ·Ä≠·ÄØ·ÄÖ·ÄÖ·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´");
      }
    })();
  </script>
</body>
</html>
